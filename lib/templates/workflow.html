var restify = require('restify');

var {{ methodDef.nickname }} = {
  name: '{{ methodDef.nickname }}',
  chain: [
    {
      name: '{{ methodDef.summary }}',
      timeout: 8,
      retry: 1,
      body: function (job, cb) {
        try {
          {%- if !methodDef.host -%}
            job.result = { {{ methodDef.nickname }}: "Workflow schema must specify a host url"};
            return cb(null,'{{ methodDef.nickname }}: {{ methodDef.summary }}' + ': Workflow scheme must specify a host url');
          {%- endif -%}

          var client = restify.createJsonClient({ url: 'http://{{ methodDef.host }}' });

          // call service
          return client.get(job.url, function(err, req, res, obj) {
            if(err) {
              return cb(err.name + ': ' + err.body.message);
            }

            job.result = obj;
            // callback message to track the workflow...
            cb(null,'{{ methodDef.nickname }}: {{ methodDef.summary }}' + ': Workflow Succeeded...');
          });
        } catch(ex) {
          console.log(ex);
        }
      },
      fallback: function (err, job, cb) {
        console.log(err);
        job.result = '{{ methodDef.nickname }}: {{ methodDef.summary }}' + ': Workflow failed: ' + err;
        cb("Error");
      }
    }
  ],
  timeout: 9,
  onerror: [
     {
        name: 'Rollback',
        body: function (job, cb) {
          cb("Error");
        }
     }
  ]
}

module.exports = {{ methodDef.nickname }};

